"use strict";(function($){var moduleName;var settings;var uiid=+new Date();if(!(window.console&&console.log)){console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}}}function getURLParam(name){var param=new RegExp("[?|&]"+name+"=(.+?)(&|$)").exec(location.href);return(param)?decodeURIComponent(param[1]):""}if(typeof ODSA==="undefined"){var odsaSettings={};odsaSettings.BOOK_NAME=getURLParam("bookName");odsaSettings.SERVER_URL=getURLParam("serverURL");odsaSettings.MODULE_ORIGIN=getURLParam("moduleOrigin");odsaSettings.MODULE_NAME=getURLParam("module");odsaSettings.DEBUG_MODE=(getURLParam("debugMode")==="true");if(odsaSettings.MODULE_ORIGIN===""){odsaSettings.MODULE_ORIGIN=location.protocol+"//"+location.host}window.ODSA={};window.ODSA.SETTINGS=odsaSettings}settings=ODSA.SETTINGS;if(settings.SERVER_URL!==""&&!settings.SERVER_URL.match(/^https:/)){console.warn("Backend communication should use HTTPS")}settings.AV_NAME="";function getType(obj){if(typeof obj!=="undefined"){return Object.prototype.toString.call(obj).slice(8,-1).toLowerCase()}return"undefined"}function getUsername(){if(localStorage.session){var session=JSON.parse(localStorage.session);return session.username}return"guest"}function getSessionKey(){if(localStorage.session){var session=JSON.parse(localStorage.session);return session.key}return""}function userLoggedIn(){return localStorage.session}function serverEnabled(){return(settings.SERVER_URL!=="")}function roundPercent(number){return Math.round(number*100)/100}function isJSAVControl(item){return(item&&item.parentElement&&item.parentElement.className.match(/.*jsav\w*control.*/)!==null)}function getJSON(data){if(settings.DEBUG_MODE){console.group("getJSON()");console.debug(JSON.stringify(data))}if(typeof data==="undefined"){if(settings.DEBUG_MODE){console.warn("getJSON() error: data is undefined");console.groupEnd()}return{}}if(getType(data)==="string"){data=jQuery.parseJSON(data)}if(settings.DEBUG_MODE){console.groupEnd()}return data}function isValidEvent(data){var missingFields=[];if(typeof data.type==="undefined"){missingFields.push("type")}if(typeof data.desc==="undefined"){missingFields.push("desc")}if(typeof data.av==="undefined"){missingFields.push("av")}if(typeof data.uiid==="undefined"){missingFields.push("uiid")}if(missingFields.length===1){console.warn("Invalid event, '"+missingFields[0]+"' is undefined");console.log(data);return false}else{if(missingFields.length>1){console.warn("Invalid event, '"+missingFields.join(", ")+"' are undefined");console.log(data);return false}}return true}function logEvent(data){if(settings.DEBUG_MODE){console.group("logEvent("+data+")");console.debug(data)}if(serverEnabled()){data=getJSON(data);var reqAttrib=["av","desc","module_name","steps_fixed","tstamp","type","uiid"];for(var prop in data){if(data.hasOwnProperty(prop)&&reqAttrib.indexOf(prop)===-1){if(settings.DEBUG_MODE){console.warn("Discarding property: "+prop)}delete data.prop}}if(typeof data.av==="undefined"){data.av=""}if(typeof data.uiid==="undefined"){data.uiid=uiid}if(!isValidEvent(data)){console.warn("logEvent() error: Invalid event");console.log(data);if(settings.DEBUG_MODE){console.groupEnd()}return}if(data.av===""&&moduleName===""){if(settings.DEBUG_MODE){console.warn('Exercise name and moduleName cannot both be ""');console.groupEnd()}return}data.module=moduleName;if(data.tstamp){data.tstamp=new Date(data.tstamp).getTime()}else{data.tstamp=(new Date()).getTime()}var eventData=getJSON(localStorage.event_data);if(!eventData[settings.BOOK_NAME]){if(settings.DEBUG_MODE){console.debug("Creating a new event_data entry for "+settings.BOOK_NAME)}eventData[settings.BOOK_NAME]=[]}eventData[settings.BOOK_NAME].push(data);localStorage.event_data=JSON.stringify(eventData)}if(settings.DEBUG_MODE){console.groupEnd()}}function logUserAction(type,desc,exerName,eventUiid){exerName=(exerName)?exerName:settings.AV_NAME;eventUiid=(eventUiid)?eventUiid:uiid;if(settings.DEBUG_MODE){console.group("logUserAction("+type+", "+desc+", "+exerName+", "+eventUiid+")")}if(serverEnabled()){var eventData={};eventData.type=type;eventData.desc=desc;eventData.av=exerName;eventData.uiid=eventUiid;logEvent(eventData)}if(settings.DEBUG_MODE){console.groupEnd()}}function sendEventData(){if(settings.DEBUG_MODE){console.group("sendEventData()")}if(serverEnabled()){var eventData=getJSON(localStorage.event_data),eventStr="";if(eventData[settings.BOOK_NAME]){eventStr=JSON.stringify(eventData[settings.BOOK_NAME]);eventData[settings.BOOK_NAME]=[];localStorage.event_data=JSON.stringify(eventData)}if(eventStr===""||eventStr==="[]"){if(settings.DEBUG_MODE){console.debug("No event data to send");console.groupEnd()}return true}var sessionKey=getSessionKey();eventData={};eventData.key=(sessionKey)?sessionKey:"phantom-key";eventData.book=settings.BOOK_NAME;eventData.actions=eventStr;if(settings.DEBUG_MODE){console.debug("Sending eventData:");console.debug(eventData)}jQuery.ajax({url:settings.SERVER_URL+"/api/v1/user/exercise/avbutton/",type:"POST",data:eventData,contentType:"application/json; charset=utf-8",datatype:"json",xhrFields:{withCredentials:true},success:function(data){data=getJSON(data);if(!data.success){console.group("Event data rejected by server");console.debug(eventData);console.groupEnd()}},error:function(data){data=getJSON(data);if(data.status===400){console.group("Event data rejected by server");console.debug(eventData);console.groupEnd()}else{var key=eventData.key,actions=getJSON(eventStr);eventData=getJSON(localStorage.event_data);for(var i=0;i<actions.length;i++){eventData[settings.BOOK_NAME].push(actions[i])}localStorage.event_data=JSON.stringify(eventData);if(data.status===401){$("body").trigger("odsa-session-expired",[key])}else{console.group("Error sending event data");console.debug(data);console.groupEnd()}}}})}if(settings.DEBUG_MODE){console.groupEnd()}}function buttonLogger(){if(serverEnabled()){var type="",desc="";if(this.id!==""){type=this.type+"-"+this.id}else{type=this.type;console.warn(this.value+" button does not have an ID")}if(this.hasAttribute("data-desc")){desc=this.getAttribute("data-desc")}else{if(this.value!==""){desc=this.value}else{if(this.id!==""){desc=this.id}else{if(this.name!==""){desc=this.name}}}}logUserAction(type,desc)}}function linkLogger(){if(serverEnabled()){var type="",desc={href:this.href,text:$(this).html};if(settings.AV_NAME===""&&this.form){settings.AV_NAME=this.form.id}if(this.id!==""){type="hyperlink-"+this.id}else{type="hyperlink";console.warn("Link ("+this.href+") does not have an ID")}logUserAction(type,desc)}}$(document).ready(function(){moduleName=settings.MODULE_NAME;var localStorageEnabled=function(){var enabled,uid=+new Date();try{localStorage[uid]=uid;enabled=(localStorage[uid]===uid);localStorage.removeItem(uid);return enabled}catch(e){return false}};if(!localStorageEnabled){if(jQuery){warn("You must enable DOM storage in your browser.",false)}return}$(":button").each(function(index,item){if(!isJSAVControl(item)){$(item).click(buttonLogger)}});$("a").each(function(index,item){if(!isJSAVControl(item)&&$(item).attr("id")!=="logon"&&$(item).attr("class")!=="close"){$(item).click(linkLogger)}})});var odsaUtils={};odsaUtils.serverEnabled=serverEnabled;odsaUtils.getUsername=getUsername;odsaUtils.getSessionKey=getSessionKey;odsaUtils.userLoggedIn=userLoggedIn;odsaUtils.getJSON=getJSON;odsaUtils.logUserAction=logUserAction;odsaUtils.logEvent=logEvent;odsaUtils.sendEventData=sendEventData;odsaUtils.roundPercent=roundPercent;odsaUtils.getType=getType;window.ODSA.UTILS=odsaUtils}(jQuery));